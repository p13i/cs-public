on:
  schedule:
    - cron: "59 23 * * WED,SAT"
  push:
    branches:
      - "main"
  pull_request:
    paths:
      - "cs/**"
      - ".bazelrc"
      - ".clang-format"
      - ".env"
      - ".prettierignore"
      - "**.BUILD"
      - "Makefile"
      - "**.bazel"

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  bazel:
    runs-on: ubuntu-24.04

    steps:
      - name: Install base deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates curl gnupg git make python3 \
            python3-pip build-essential openjdk-17-jdk-headless \
            nodejs npm

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---- Caches (speed up repeated runs) ----
      - name: Cache Bazel & Bazelisk
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-${{ runner.os }}-${{ hashFiles('**/BUILD', '**/*.BUILD', '**/MODULE.bazel', '**/*.bzl') }}
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Cache Go modules & tools
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/go/bin
          key: go-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-${{ runner.os }}-

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/npm-shrinkwrap.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/poetry.lock') }}
          restore-keys: |
            pip-${{ runner.os }}-

      # ---- Pin toolchain versions for lint consistency ----
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.17.0"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.7"

      - name: Install Bazelisk
        run: |
          sudo rm -f /usr/local/bin/bazel
          sudo curl -fsSL https://github.com/bazelbuild/bazelisk/releases/download/v1.21.0/bazelisk-linux-amd64 -o /usr/local/bin/bazel
          sudo chmod +x /usr/local/bin/bazel

      - name: Install clang-format 18
        run: |
          sudo apt-get update
          curl -fsSL https://apt.llvm.org/llvm-snapshot.gpg.key | \
            sudo gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] https://apt.llvm.org/noble/ llvm-toolchain-noble-18 main" | \
            sudo tee /etc/apt/sources.list.d/llvm-toolchain-noble-18.list >/dev/null
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang-format-18=1:18.1.8~++20240731025043+3b5b5c1ec4a3-1~exp1~20240731145144.92 \
            lcov=2.0-4ubuntu2
          sudo ln -sf /usr/bin/clang-format-18 /usr/local/bin/clang-format

      - name: Install JS formatters
        run: npm install -g prettier@3.7.4
        #  prettier-plugin-rust@0.4.1

      # - name: Install buildifier
      #   run: GOBIN=/usr/local/bin go install github.com/bazelbuild/buildtools/buildifier@v6.4.0

      # ---- Setup once (reused by all following steps in this job) ----
      - name: Setup
        run: make setup

      # ---- Lint & auto-fix; open PR if diffs were produced ----
      - name: Run linters (may modify files)
        run: make lint

      - name: Show lint diffs
        if: ${{ always() }}
        run: |
          set -euo pipefail
          if ! git diff --quiet --ignore-submodules --; then
            echo "Unstaged diff:"
            git --no-pager diff
          else
            echo "No unstaged diff."
          fi

      - name: Assert no diffs (captures outcome)
        id: assert
        continue-on-error: true
        run: |
          make assert-no-diffs

      - name: Create pull request with formatting changes
        if: ${{ steps.assert.outcome == 'failure' }}
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Apply lint tools to ${{ github.ref_name }}
          title: Apply lint tools to ${{ github.ref_name }}
          branch: bazel-${{ github.run_number }}
          body: |
            This pull request applies formatting changes (buildifier/clang-format/prettier/black)
            produced by the CI run at ${{ github.sha }}.
          labels: auto-generated
          reviewers: ${{ github.actor }}

      - name: Store pull request number
        if: ${{ steps.assert.outcome == 'failure' && steps.cpr.outputs.pull-request-number }}
        run: echo "PR_NUMBER=${{ steps.cpr.outputs.pull-request-number }}" >> "$GITHUB_ENV"

      # ---- Only build & test if lint produced no diffs ----
      - name: Build
        if: ${{ steps.assert.outcome == 'success' }}
        run: make build

      - name: Test
        if: ${{ steps.assert.outcome == 'success' }}
        run: make test

      - name: Coverage
        if: ${{ steps.assert.outcome == 'success' }}
        run: make coverage

      - name: Upload coverage (Codecov)
        if: ${{ steps.assert.outcome == 'success' }}
        uses: codecov/codecov-action@v4
        with:
          files: bazel-out/_coverage/_coverage_report.dat
          token: ${{ secrets.CODECOV_TOKEN }}
      
      # ---- Conditional release & PR ----
      - name: Compute release metadata
        id: relmeta
        if: ${{ success() && steps.assert.outcome == 'success' && contains(github.event.head_commit.message, 'ci:release') }}
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::7}"

          # Derive VERSION from (in order): make print-version | VERSION file | latest tag | fallback
          VERSION=""
          if make -n print-version >/dev/null 2>&1; then
            VERSION="$(make -s print-version)"
          elif [ -f VERSION ]; then
            VERSION="$(sed -n '1s/^[[:space:]]*//p;q' VERSION)"
          else
            VERSION="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          fi
          [ -n "$VERSION" ] || VERSION="0.0.0+dev"

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"
          echo "branch_name=release/v${VERSION}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
      
      - name: Release (conditional on "ci:release")
        id: release
        if: ${{ success() && steps.assert.outcome == 'success' && contains(github.event.head_commit.message, 'ci:release') }}
        run: make release

      - name: Create pull request for release
        if: ${{ steps.release.outcome == 'success' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[release] v${{ steps.relmeta.outputs.version }} (${{ steps.relmeta.outputs.short_sha }})"
          title: "[release] v${{ steps.relmeta.outputs.version }} (${{ steps.relmeta.outputs.short_sha }})"
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref_name || github.event.repository.default_branch }}
          branch: ${{ steps.relmeta.outputs.branch_name }}
          body: |
            Automated release PR from `${{ github.ref_name }}` at `${{ github.sha }}`.
            - Version: v${{ steps.relmeta.outputs.version }}
            - Commit: ${{ steps.relmeta.outputs.short_sha }}
            Triggered by `ci:release` in the commit message.
          labels: release
          reviewers: ${{ github.actor }}

      - name: Cause job failure if assertion step failed
        id: assertion-exit
        if: ${{ steps.assert.outcome == 'failure' }}
        run: exit 1
