# Infrastructure as Code Specification
# This is the SOURCE OF TRUTH for all docker configs
#
# To apply changes:
#   1. Edit this file (system.gpt.yml)
#   2. Run: make expand
#   3. Commit both this file and the generated docker files
#
# Generated files (do not edit manually):
#   - Dockerfile
#   - docker-compose.yml
#   - docker-compose.dev.yml
#
# Intelligent caching:
# Images are tagged with content hashes (e.g., cs-app:www-trycopilot-ai-abc123)
# computed from source files. Docker only rebuilds when source changes.
# Use 'make expand-check' to see which services need rebuilding.

# Named volumes used by services (volume key on service = mount at /data).
volumes:
  database-volume: {}
  blob-volume: {}
  scribe-workspace-volume: {}

services:
  www-trycopilot-ai:
    type: web-application
    source: cs/apps/trycopilot.ai

    network:
      interface: private

    replicas:
      prod: 5
      dev: 3

    security:
      isolation: unprivileged

    config:
      - VERSION
      - COMMIT

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --version=${VERSION}
      - --commit=${COMMIT}

  www-cite-pub:
    type: web-application
    source: cs/apps/cite.pub

    container_name: true

    network:
      interface: public
      port: 8080

    replicas: 1

    security:
      isolation: user-namespaced

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080

  code-viewer:
    type: web-application
    source: cs/apps/code-viewer

    copy_from_stage:
      - stage: cs-public
        source: /cs-public
        dest: /cs-public

    network:
      interface: private

    replicas: 3

    security:
      isolation: unprivileged

    config:
      - VERSION
      - COMMIT

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --version=${VERSION}
      - --commit=${COMMIT}

  data-viewer:
    type: web-application
    source: cs/apps/data-viewer

    volume: database-volume

    network:
      interface: private

    replicas: 1

    security:
      isolation: unprivileged

    config:
      - VERSION
      - COMMIT

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --version=${VERSION}
      - --commit=${COMMIT}

  database-service:
    type: data-store
    source: cs/apps/database-service

    volume: database-volume

    network:
      interface: private

    replicas: 1

    security:
      isolation: privileged

    command:
      - /main
      - --host=0.0.0.0
      - --data_dir=/data
      - --port=8080

  message-queue:
    type: web-application
    source: cs/apps/message-queue

    network:
      interface: private

    replicas: 3

    security:
      isolation: unprivileged

    dependencies:
      - service: database-service
        requirement: available

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080

  task-queue-service:
    type: web-application
    source: cs/apps/task-queue-service

    network:
      interface: private

    replicas: 1

    security:
      isolation: unprivileged

    dependencies:
      - service: message-queue
        requirement: available
      - service: database-service
        requirement: available

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --broker_base_url=http://message-queue:8080
      - --consumer_service=task-queue-service
      - --database_base_url=http://database-service:8080

  blob-service:
    type: web-application
    source: cs/apps/blob-service

    volume: blob-volume

    network:
      interface: private

    replicas: 3

    security:
      isolation: unprivileged

    dependencies:
      - service: database-service
        requirement: available

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080

  blob-viewer:
    type: web-application
    source: cs/apps/blob-viewer

    volume: blob-volume

    network:
      interface: private

    replicas: 1

    security:
      isolation: unprivileged

    config:
      - VERSION
      - COMMIT

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --version=${VERSION}
      - --commit=${COMMIT}

  scribe-service:
    type: web-application
    source: cs/apps/scribe-service

    network:
      interface: private

    replicas: 1

    security:
      isolation: unprivileged

    dependencies:
      - service: blob-service
        requirement: available
      - service: database-service
        requirement: available
      - service: message-queue
        requirement: available

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080
      - --blob_base_url=http://blob-service:8080
      - --database_base_url=http://database-service:8080
      - --task_queue_base_url=http://message-queue:8080

  scribe-worker:
    type: web-application
    source: cs/apps/scribe-worker

    volume: scribe-workspace-volume

    network:
      interface: private

    replicas: 1

    security:
      isolation: privileged

    dependencies:
      - service: blob-service
        requirement: available
      - service: scribe-service
        requirement: available
      - service: message-queue
        requirement: available

    mounts:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    command:
      - /main
      - --broker_base_url=http://message-queue:8080
      - --consumer_service=scribe-worker
      - --blob_base_url=http://blob-service:8080
      - --database_base_url=http://database-service:8080
      - --workspace_dir=/data/scribe-workspace
      - --docker_socket=/var/run/docker.sock

  load-balancer:
    type: reverse-proxy
    source: cs/apps/load-balancer

    inject_environment: true

    network:
      interface:
        prod: private
        dev: public
      port: 8080

    replicas: 1

    dependencies:
      - service: database-service
        requirement: available
      - service: service-registry
        requirement: available
      - service: www-trycopilot-ai
        requirement: available
      - service: www-cite-pub
        requirement: available

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080

  service-registry:
    type: orchestration
    source: cs/apps/service-registry

    container_name: true

    mounts:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-cs}

    network:
      interface: private

    replicas: 1

    security:
      isolation: privileged

    runtime:
      packages:
        - docker.io

    command:
      - /main
      - --host=0.0.0.0
      - --port=8080

  ngrok:
    type: tunnel

    network:
      management_port: 4040

    replicas: 1
    restart_policy: manual

    # Domain mappings: which domains route to which services
    # The system automatically determines service ports from their network config
    # and generates the full ngrok YAML configuration
    expose:
      load-balancer:
        # domain2service
        mapping:
          www.trycopilot.ai: www-trycopilot-ai
          code.trycopilot.ai: code-viewer
          data.trycopilot.ai: data-viewer
          blob.trycopilot.ai: blob-viewer
          www.cite.pub: www-cite-pub
          scribe.trycopilot.ai: scribe-service
        prod:
          [
            www.trycopilot.ai,
            code.trycopilot.ai,
            data.trycopilot.ai,
            blob.trycopilot.ai,
            www.cite.pub,
            scribe.trycopilot.ai
          ]
        dev:
          [
            dev.www.trycopilot.ai,
            dev.code.trycopilot.ai,
            dev.data.trycopilot.ai,
            dev.blob.trycopilot.ai,
            dev.www.cite.pub,
            dev.scribe.trycopilot.ai
          ]

    dependencies:
      - service: load-balancer
